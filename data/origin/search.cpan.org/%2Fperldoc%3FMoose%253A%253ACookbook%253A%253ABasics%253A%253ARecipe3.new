<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
 <head>
  <link rel="stylesheet" href="http://st.pimg.net/tucs/style.css" type="text/css" />
<style>
.styleswitch {
  text-align: right;
}
</style>


<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="http://st.pimg.net/tucs/js/jquery.cookie.js"></script>
<script type="text/javascript" src="http://st.pimg.net/tucs/js/sh_main.min.js"></script>
<script type="text/javascript" src="http://st.pimg.net/tucs/js/sh_perl.min.js"></script>
<script type="text/javascript" src="http://st.pimg.net/tucs/js/jquery.styleswitch.js"></script>

<link rel="stylesheet" href="http://st.pimg.net/tucs/print.css" type="text/css" media="print" />
  <link rel="alternate" type="application/rss+xml" title="RSS 1.0" href="http://search.cpan.org/uploads.rdf" />
  <link rel="search" href="http://st.pimg.net/tucs/opensearch.xml" type="application/opensearchdescription+xml" title="SearchCPAN" />
  <title>Moose::Cookbook::Basics::Recipe3 - search.cpan.org</title>
 <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3528438-1']);
    _gaq.push(["_setCustomVar",2,"Distribution","Moose",3]);
    _gaq.push(["_setCustomVar",5,"Release","Moose-2.0403",3]);
    _gaq.push(["_setCustomVar",4,"Document","Moose::Cookbook::Basics::Recipe3",3]);
    _gaq.push(["_setCustomVar",1,"Author","DOY",3]);
    _gaq.push(['_trackPageview']);
  </script>
 </head>
 <body id="cpansearch">
<center><div class="logo"><a href="/"><img src="http://st.pimg.net/tucs/img/cpan_banner.png" alt="CPAN"></a></div></center>
<div class="menubar">
 <a href="/">Home</a>
&middot; <a href="/author/">Authors</a>
&middot; <a href="/recent">Recent</a>
&middot; <a href="http://log.perl.org/cpansearch/">News</a>
&middot; <a href="/mirror">Mirrors</a>
&middot; <a href="/faq.html">FAQ</a>
&middot; <a href="/feedback">Feedback</a>
</div>
<form method="get" action="/search" name="f" class="searchbox">
<input type="text" name="query" value="" size="35">
<br>in <select name="mode">
 <option value="all">All</option>
 <option value="module" >Modules</option>
 <option value="dist" >Distributions</option>
 <option value="author" >Authors</option>
</select>&nbsp;<input type="submit" value="CPAN Search">
</form>


 <a name="_top"></a>
  <div class=path>
<div id=permalink class="noprint"><a href="/perldoc?Moose::Cookbook::Basics::Recipe3">permalink</a></div>
  <a href="/~doy/">Jesse Luehrs</a> &gt;
  <a href="/~doy/Moose-2.0403/">Moose-2.0403</a> &gt;
  Moose::Cookbook::Basics::Recipe3
 </div>

<div class="noprint" style="float:right;align:left;width:19ex">
<a href="http://hexten.net/cpan-faces/"><img src="http://www.gravatar.com/avatar/88766de7a058697d3d0335b8d384fd2a?r=g&s=80&d=http%3A%2F%2Fst.pimg.net%2Ftucs%2Fimg%2Fwho.png" width=80 height=80 
style="float:right"
/></a>
<br style="clear:both"/>
<p style="text-align:right">Download:<br/> <a href="/CPAN/authors/id/D/DO/DOY/Moose-2.0403.tar.gz">Moose-2.0403.tar.gz</a></p>
<p style="text-align:right"><a href="http://www.annocpan.org/~DOY/Moose-2.0403/lib/Moose/Cookbook/Basics/Recipe3.pod">Annotate this POD
</a></p>

<div style="float:right">
<div class=box style='width:150px'>
<h1 class=t5>CPAN RT</h1>
<div style="margin:2px">
<table style="margin-left:auto;margin-right:auto">
<tr><td>New&nbsp;</td><td style="text-align:right"> 13</td></tr>
<tr><td>Open&nbsp;</td><td style="text-align:right"> 27</td></tr>
<tr><td>Stalled&nbsp;</td><td style="text-align:right"> 4</td></tr>
</table>
<a href="http://rt.cpan.org/NoAuth/Bugs.html?Dist=Moose">View/Report Bugs</a><br/>
</div>
</div>

</div>
</div>
<span class="noprint">
  <a href="/src/DOY/Moose-2.0403/lib/Moose/Cookbook/Basics/Recipe3.pod">Source</a> &nbsp;
</span>
<a name="___top"></a>
<div class=pod>
<div class=toc>
<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#VERSION'>VERSION</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#CONCLUSION'>CONCLUSION</a>
  <li class='indexItem indexItem1'><a href='#FOOTNOTES'>FOOTNOTES</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#COPYRIGHT_AND_LICENSE'>COPYRIGHT AND LICENSE</a>
</ul>
</div>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME <img alt='^' src='http://st.pimg.net/tucs/img/up.gif'></a></h1>

<p>Moose::Cookbook::Basics::Recipe3 - A lazy <b>BinaryTree</b> example</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="VERSION"
>VERSION <img alt='^' src='http://st.pimg.net/tucs/img/up.gif'></a></h1>

<p>version 2.0403</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS <img alt='^' src='http://st.pimg.net/tucs/img/up.gif'></a></h1>

<pre class="sh_perl">  package BinaryTree;
  use Moose;

  has &#39;node&#39; =&#62; ( is =&#62; &#39;rw&#39;, isa =&#62; &#39;Any&#39; );

  has &#39;parent&#39; =&#62; (
      is        =&#62; &#39;rw&#39;,
      isa       =&#62; &#39;BinaryTree&#39;,
      predicate =&#62; &#39;has_parent&#39;,
      weak_ref  =&#62; 1,
  );

  has &#39;left&#39; =&#62; (
      is        =&#62; &#39;rw&#39;,
      isa       =&#62; &#39;BinaryTree&#39;,
      predicate =&#62; &#39;has_left&#39;,
      lazy      =&#62; 1,
      default   =&#62; sub { BinaryTree-&#62;new( parent =&#62; $_[0] ) },
      trigger   =&#62; \&#38;_set_parent_for_child
  );

  has &#39;right&#39; =&#62; (
      is        =&#62; &#39;rw&#39;,
      isa       =&#62; &#39;BinaryTree&#39;,
      predicate =&#62; &#39;has_right&#39;,
      lazy      =&#62; 1,
      default   =&#62; sub { BinaryTree-&#62;new( parent =&#62; $_[0] ) },
      trigger   =&#62; \&#38;_set_parent_for_child
  );

  sub _set_parent_for_child {
      my ( $self, $child ) = @_;

      confess &#34;You cannot insert a tree which already has a parent&#34;
          if $child-&#62;has_parent;

      $child-&#62;parent($self);
  }</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION <img alt='^' src='http://st.pimg.net/tucs/img/up.gif'></a></h1>

<p>This recipe shows how various advanced attribute features can be used to create complex and powerful behaviors. In particular, we introduce a number of new attribute options, including <code>predicate</code>, <code>lazy</code>, and <code>trigger</code>.</p>

<p>The example class is a classic binary tree. Each node in the tree is itself an instance of <code>BinaryTree</code>. It has a <code>node</code>, which holds some arbitrary value. It has <code>right</code> and <code>left</code> attributes, which refer to its child trees, and a <code>parent</code>.</p>

<p>Let&#39;s take a look at the <code>node</code> attribute:</p>

<pre class="sh_perl">  has &#39;node&#39; =&#62; ( is =&#62; &#39;rw&#39;, isa =&#62; &#39;Any&#39; );</pre>

<p>Moose generates a read-write accessor for this attribute. The type constraint is <code>Any</code>, which literally means it can contain anything.</p>

<p>We could have left out the <code>isa</code> option, but in this case, we are including it for the benefit of other programmers, not the computer.</p>

<p>Next, let&#39;s move on to the <code>parent</code> attribute:</p>

<pre class="sh_perl">  has &#39;parent&#39; =&#62; (
      is        =&#62; &#39;rw&#39;,
      isa       =&#62; &#39;BinaryTree&#39;,
      predicate =&#62; &#39;has_parent&#39;,
      weak_ref  =&#62; 1,
  );</pre>

<p>Again, we have a read-write accessor. This time, the <code>isa</code> option says that this attribute must always be an instance of <code>BinaryTree</code>. In the second recipe, we saw that every time we create a Moose-based class, we also get a corresponding class type constraint.</p>

<p>The <code>predicate</code> option is new. It creates a method which can be used to check whether or not a given attribute has been initialized. In this case, the method is named <code>has_parent</code>.</p>

<p>This brings us to our last attribute option, <code>weak_ref</code>. Since <code>parent</code> is a circular reference (the tree in <code>parent</code> should already have a reference to this one, in its <code>left</code> or <code>right</code> attribute), we want to make sure that we weaken the reference to avoid memory leaks. If <code>weak_ref</code> is true, it alters the accessor function so that the reference is weakened when it is set.</p>

<p>Finally, we have the the <code>left</code> and <code>right</code> attributes. They are essentially identical except for their names, so we&#39;ll just look at <code>left</code>:</p>

<pre class="sh_perl">  has &#39;left&#39; =&#62; (
      is        =&#62; &#39;rw&#39;,
      isa       =&#62; &#39;BinaryTree&#39;,
      predicate =&#62; &#39;has_left&#39;,
      lazy      =&#62; 1,
      default   =&#62; sub { BinaryTree-&#62;new( parent =&#62; $_[0] ) },
      trigger   =&#62; \&#38;_set_parent_for_child
  );</pre>

<p>There are three new options here, <code>lazy</code>, <code>default</code>, and <code>trigger</code>. The <code>lazy</code> and <code>default</code> options options are linked. In fact, you cannot have a <code>lazy</code> attribute unless it has a <code>default</code> (or a <code>builder</code>, but we&#39;ll cover that later). If you try to make an attribute lazy without a default, class creation will fail with an exception. (2)</p>

<p>In the second recipe the <b>BankAccount</b>&#39;s <code>balance</code> attribute had a default value of <code>0</code>. Given a non-reference, Perl copies the <i>value</i>. However, given a reference, it does not do a deep clone, instead simply copying the reference. If you just specified a simple reference for a default, Perl would create it once and it would be shared by all objects with that attribute.</p>

<p>As a workaround, we use an anonymous subroutine to generate a new reference every time the default is called.</p>

<pre class="sh_perl">  has &#39;foo&#39; =&#62; ( is =&#62; &#39;rw&#39;, default =&#62; sub { [] } );</pre>

<p>In fact, using a non-subroutine reference as a default is illegal in Moose.</p>

<pre class="sh_perl">  # will fail
  has &#39;foo&#39; =&#62; ( is =&#62; &#39;rw&#39;, default =&#62; [] );</pre>

<p>This will blow up, so don&#39;t do it.</p>

<p>You&#39;ll notice that we use <code>$_[0]</code> in our default sub. When the default subroutine is executed, it is called as a method on the object.</p>

<p>In our case, we&#39;re making a new <code>BinaryTree</code> object in our default, with the current tree as the parent.</p>

<p>Normally, when an object is instantiated, any defaults are evaluated immediately. With our <code>BinaryTree</code> class, this would be a big problem! We&#39;d create the first object, which would immediately try to populate its <code>left</code> and <code>right</code> attributes, which would create a new <code>BinaryTree</code>, which would populate <i>its</i> <code>left</code> and <code>right</code> slots. Kaboom!</p>

<p>By making our <code>left</code> and <code>right</code> attributes <code>lazy</code>, we avoid this problem. If the attribute has a value when it is read, the default is never executed at all.</p>

<p>We still have one last bit of behavior to add. The autogenerated <code>right</code> and <code>left</code> accessors are not quite correct. When one of these is set, we want to make sure that we update the parent of the <code>left</code> or <code>right</code> attribute&#39;s tree.</p>

<p>We could write our own accessors, but then why use Moose at all? Instead, we use a <code>trigger</code>. A <code>trigger</code> accepts a subroutine reference, which will be called as a method whenever the attribute is set. This can happen both during object construction or later by passing a new object to the attribute&#39;s accessor method. However, it is not called when a value is provided by a <code>default</code> or <code>builder</code>.</p>

<pre class="sh_perl">  sub _set_parent_for_child {
      my ( $self, $child ) = @_;

      confess &#34;You cannot insert a tree which already has a parent&#34;
          if $child-&#62;has_parent;

      $child-&#62;parent($self);
  }</pre>

<p>This trigger does two things. First, it ensures that the new child node does not already have a parent. This is done for the sake of simplifying the example. If we wanted to be more clever, we would remove the child from its old parent tree and add it to the new one.</p>

<p>If the child has no parent, we will add it to the current tree, and we ensure that is has the correct value for its <code>parent</code> attribute.</p>

<p>As with all the other recipes, <b>BinaryTree</b> can be used just like any other Perl 5 class. A more detailed example of its usage can be found in <em>t/recipes/moose_cookbook_basics_recipe3.t</em>.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CONCLUSION"
>CONCLUSION <img alt='^' src='http://st.pimg.net/tucs/img/up.gif'></a></h1>

<p>This recipe introduced several of Moose&#39;s advanced features. We hope that this inspires you to think of other ways these features can be used to simplify your code.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FOOTNOTES"
>FOOTNOTES <img alt='^' src='http://st.pimg.net/tucs/img/up.gif'></a></h1>

<dl>
<dt><a name='1'></a><a name="(1)"
>(1)</a></dt>

<dd>
<p>Weak references are tricky things, and should be used sparingly and appropriately (such as in the case of circular refs). If you are not careful, attribute values could disappear &#34;mysteriously&#34; because Perl&#39;s reference counting garbage collector has gone and removed the item you are weak-referencing.</p>

<p>In short, don&#39;t use them unless you know what you are doing :)</p>

<dt><a name='2'></a><a name="(2)"
>(2)</a></dt>

<dd>
<p>You <i>can</i> use the <code>default</code> option without the <code>lazy</code> option if you like, as we showed in the second recipe.</p>

<p>Also, you can use <code>builder</code> instead of <code>default</code>. See <a href="/~doy/Moose-2.0403/lib/Moose/Cookbook/Basics/Recipe8.pod" class="podlinkpod"
>Moose::Cookbook::Basics::Recipe8</a> for details.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR <img alt='^' src='http://st.pimg.net/tucs/img/up.gif'></a></h1>

<p>Moose is maintained by the Moose Cabal, along with the help of many contributors. See <a href="/~doy/Moose-2.0403/lib/Moose.pm#CABAL" class="podlinkpod"
>&#34;CABAL&#34; in Moose</a> and <a href="/~doy/Moose-2.0403/lib/Moose.pm#CONTRIBUTORS" class="podlinkpod"
>&#34;CONTRIBUTORS&#34; in Moose</a> for details.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="COPYRIGHT_AND_LICENSE"
>COPYRIGHT AND LICENSE <img alt='^' src='http://st.pimg.net/tucs/img/up.gif'></a></h1>

<p>This software is copyright (c) 2012 by Infinity Interactive, Inc..</p>

<p>This is free software; you can redistribute it and/or modify it under the same terms as the Perl 5 programming language system itself.</p>

</div>
<!-- This should probably be put in the <div class="footer"></div> -->
<script type="text/javascript">
    $(document).ready(function(){
        var startingStyle = $.cookie('css') ? $.cookie('css') : 'http://st.pimg.net/tucs/css/sh_none.min.css';
        $.fn.styleSwitch(startingStyle);
        $("#styleswitch").val(startingStyle);
        sh_highlightDocument();
        $("#styleswitch").bind(($.browser.msie ? "click" : "change"), function() {
            $.fn.styleSwitch($(this).val());
        });
    });
</script>
<div class="styleswitch">
    syntax highlighting:
    <select id="styleswitch">
        <option value="http://st.pimg.net/tucs/css/sh_none.min.css">no syntax highlighting</option>
        <option value="http://st.pimg.net/tucs/css/sh_acid.min.css">acid</option>
        <option value="http://st.pimg.net/tucs/css/sh_berries-dark.min.css">berries-dark</option>
        <option value="http://st.pimg.net/tucs/css/sh_berries-light.min.css">berries-light</option>
        <option value="http://st.pimg.net/tucs/css/sh_bipolar.min.css">bipolar</option>
        <option value="http://st.pimg.net/tucs/css/sh_blacknblue.min.css">blacknblue</option>
        <option value="http://st.pimg.net/tucs/css/sh_bright.min.css">bright</option>
        <option value="http://st.pimg.net/tucs/css/sh_contrast.min.css">contrast</option>
        <option value="http://st.pimg.net/tucs/css/sh_cpan.min.css">cpan</option>
        <option value="http://st.pimg.net/tucs/css/sh_darkblue.min.css">darkblue</option>
        <option value="http://st.pimg.net/tucs/css/sh_darkness.min.css">darkness</option>
        <option value="http://st.pimg.net/tucs/css/sh_desert.min.css">desert</option>
        <option value="http://st.pimg.net/tucs/css/sh_dull.min.css">dull</option>
        <option value="http://st.pimg.net/tucs/css/sh_easter.min.css">easter</option>
        <option value="http://st.pimg.net/tucs/css/sh_emacs.min.css">emacs</option>
        <option value="http://st.pimg.net/tucs/css/sh_golden.min.css">golden</option>
        <option value="http://st.pimg.net/tucs/css/sh_greenlcd.min.css">greenlcd</option>
        <option value="http://st.pimg.net/tucs/css/sh_ide-anjuta.min.css">ide-anjuta</option>
        <option value="http://st.pimg.net/tucs/css/sh_ide-codewarrior.min.css">ide-codewarrior</option>
        <option value="http://st.pimg.net/tucs/css/sh_ide-devcpp.min.css">ide-devcpp</option>
        <option value="http://st.pimg.net/tucs/css/sh_ide-eclipse.min.css">ide-eclipse</option>
        <option value="http://st.pimg.net/tucs/css/sh_ide-kdev.min.css">ide-kdev</option>
        <option value="http://st.pimg.net/tucs/css/sh_ide-msvcpp.min.css">ide-msvcpp</option>
        <option value="http://st.pimg.net/tucs/css/sh_kwrite.min.css">kwrite</option>
        <option value="http://st.pimg.net/tucs/css/sh_matlab.min.css">matlab</option>
        <option value="http://st.pimg.net/tucs/css/sh_navy.min.css">navy</option>
        <option value="http://st.pimg.net/tucs/css/sh_nedit.min.css">nedit</option>
        <option value="http://st.pimg.net/tucs/css/sh_neon.min.css">neon</option>
        <option value="http://st.pimg.net/tucs/css/sh_night.min.css">night</option>
        <option value="http://st.pimg.net/tucs/css/sh_pablo.min.css">pablo</option>
        <option value="http://st.pimg.net/tucs/css/sh_peachpuff.min.css">peachpuff</option>
        <option value="http://st.pimg.net/tucs/css/sh_print.min.css">print</option>
        <option value="http://st.pimg.net/tucs/css/sh_rand01.min.css">rand01</option>
	<option value="http://st.pimg.net/tucs/css/sh_solarized-dark.min.css">solarized-dark</option>
	<option value="http://st.pimg.net/tucs/css/sh_solarized-light.min.css">solarized-light</option>
        <option value="http://st.pimg.net/tucs/css/sh_style.min.css">style</option>
        <option value="http://st.pimg.net/tucs/css/sh_the.min.css">the</option>
        <option value="http://st.pimg.net/tucs/css/sh_typical.min.css">typical</option>
        <option value="http://st.pimg.net/tucs/css/sh_vampire.min.css">vampire</option>
        <option value="http://st.pimg.net/tucs/css/sh_vim-dark.min.css">vim-dark</option>
        <option value="http://st.pimg.net/tucs/css/sh_vim.min.css">vim</option>
        <option value="http://st.pimg.net/tucs/css/sh_whatis.min.css">whatis</option>
        <option value="http://st.pimg.net/tucs/css/sh_whitengrey.min.css">whitengrey</option>
        <option value="http://st.pimg.net/tucs/css/sh_zellner.min.css">zellner</option>
    </select>
</div>



<div class="footer"><div class="cpanstats">78191 Uploads, 24710 Distributions
106007 Modules, 9645 Uploaders
</div>
hosted by <a href="http://www.yellowbot.com">YellowBot</a><br/>
<a href="http://www.yellowbot.com"><img alt="do. tag. write. share." src="http://st.pimg.net/tucs/img/yellowbot_logo.gif"></a>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript" src="http://ipv4.v6test.develooper.com/js/v1/v6test.js"></script>

<script type="text/javascript">
   // v6.target = '';
   if (!v6.target) { v6.only_once = true }
   v6.site = '7A0D89A6-2B82-11DF-B9DA-F61CBD13F020';
   v6.api_server = 'http://ipv4.v6test.develooper.com';
   try {
     v6.test();
   } catch(err) {}
</script>
<script type="text/javascript">
  $(document).ready(function(){
    $("a[href^=http:]").click(function(){
      var href = $(this).attr('href');
      var m = href.match('\/\/([^\/:]+)');
      _gaq.push(['_trackEvent','External',m[1],'Document']);
    });
    $("a[href^=/CPAN/]").click(function(){
      var href = $(this).attr('href');
      _gaq.push(['_trackEvent','Download',href,'Document']);
    });
  });
</script>
<!-- Wed Apr 25 11:58:15 2012 GMT (0.125179052352905) @cpansearch1 -->
 </body>
</html>
